<?php
// Call userTest::main() if this source file is executed directly.
if (!defined('PHPUnit_MAIN_METHOD')) {
    define('PHPUnit_MAIN_METHOD', 'userTest::main');
}

require_once 'PHPUnit/Framework.php';
require_once '../../include/config_inc.php';
require_once( TBW_ROOT.'engine/include.php' );
require_once( TBW_ROOT.'engine/classes/galaxy.php' );

define( 'TEST_MAX_GALAXIES', 2 );
define( 'TEST_MAX_SYSTEMSINGALAXY', 999 );
define( 'TEST_MAX_PLANETSINSYSTEM', 50 );

/**
 * Test class for user.
 * Generated by PHPUnit on 2009-10-31 at 06:39:22.
 */
class userTest extends PHPUnit_Framework_TestCase
{
	private $testUname1 = 'helmut';
	private $testUname2 = 'bernd';
	private $testUname3 = 'olaf';
	private $testCreateUname = 'hans';
	private $testNoUname = 'randomusernotcreatedbefore';

	// used during development, skip tests which are working
	private $skipOldTests = true;

	/*
	 * holds all fleets created
	 * array( fleetname )
	 */
	private $test_Fleets = array();

	/*
	 * keeps the random item levels which were set to make sure they were set
	 * array( user, array ( planet, array( itemID, itemLevel ) ) )
	 */
	private $random_ItemLevels = array();

	/*
	 * this holds planets which we created, values = boolean
	 * array( user, array( planetid, bWasCreated ) )
	 */
	private $test_PlanetCreated = array();

	/*
	 * this holds the names of our planets, values = string
	 * array( user, array( planetid, name ) )	
	 */
	private $test_PlanetNames = array();

	/*
	 * this holds the koordinates of our planets, values = string
	 * @array - user => ( planetid => coords )
	 */
	private $test_PlanetCoordinates = array();

	/*
	 * this holds all users used during testing
	 * array( user, array( username, wascreated ) )
	 */
	private $test_Users = array();

    /**
     * Runs the test methods of this class.
     *
     * @access public
     * @static
     */
    public static function main()
    {
        require_once 'PHPUnit/TextUI/TestRunner.php';

        $suite  = new PHPUnit_Framework_TestSuite('userTest');
        $result = PHPUnit_TextUI_TestRunner::run($suite);
    }

    /**
     * Sets up the fixture, for example, opens a network connection.
     * This method is called before a test is executed.
     *
     * @access protected
     */
    protected function setUp()
    {
		// define_globals( Uni ); to set globals like where db files are located etc
		define_globals( 'TestUni1' );
		
		if ( !$this->setUp_NewUser( $this->testUname1 ) )
			throw new Exception( 'setUp() failed, borken for status for $user obj returned' );

        if ( !$this->setUp_NewUser( $this->testUname2 ) )
            throw new Exception( 'setUp() failed, borken for status for $user obj returned' );

		// $this->test_Users[UserID][UserName]
		$this->setUp_NewPlanet( $this->test_Users[0][0], "MainPlanet" );
		$this->setUp_NewPlanet( $this->test_Users[0][0], "TestPlanet1" );

        $this->setUp_NewPlanet( $this->test_Users[1][0], "MainPlanet" );
        $this->setUp_NewPlanet( $this->test_Users[1][0], "TestPlanet1" );

		$this->setUp_RandomizePlanet( $this->test_Users[0][0], 0, true );
		$this->setUp_RandomizePlanet( $this->test_Users[0][0], 1, false );

        $this->setUp_RandomizePlanet( $this->test_Users[1][0], 0, true );
		$this->setUp_RandomizePlanet( $this->test_Users[1][0], 1, false );
    }

	protected function setUp_NewUser( $username )
	{
        $nuser = Classes::User( $username );
        $nuser->create();

        array_push( $this->test_Users, array( $username, true ) );
		$status = $nuser->getStatus();
		unset( $nuser );

		return $status;
	}

	/*
	 * helper func for setting up a random planet,
	 * sets and gets back random item levels for each class
	 */
	protected function setUp_RandomPlanet( $planet, $uname, $research = false )
	{
		$random_ItemLevels = array();

		$random_ItemLevels = array_merge( $random_ItemLevels, $this->setUp_RandomItemClass( $planet, $uname, 'gebaeude' ) );
		$random_ItemLevels = array_merge( $random_ItemLevels, $this->setUp_RandomItemClass( $planet, $uname, 'roboter' ) );
		$random_ItemLevels = array_merge( $random_ItemLevels, $this->setUp_RandomItemClass( $planet, $uname, 'schiffe' ) );
		$random_ItemLevels = array_merge( $random_ItemLevels, $this->setUp_RandomItemClass( $planet, $uname, 'verteidigung' ) );

		if ( $research )
			$random_ItemLevels = array_merge( $random_ItemLevels, $this->setUp_RandomItemClass( $planet, $uname, 'forschung' ) );

		return $random_ItemLevels;
	}

	/*
	 * setting up random items for a given class on the active planet
	 * @args $class - name the class for which all available items should be randomized
	 * @return - returns a list of the random levels with the id as key
	 */
	protected function setUp_RandomItemClass( $planet, $uname, $class )
	{
		$minlvl = 0;
		$maxlvl = 0;

		switch( $class )
		{
			case 'gebaeude' :
				$minlvl = 0;
				$maxlvl = 20;
			break;

			case 'roboter' :
				$minlvl = 0;
				$maxlvl = 200;
			break;

			case 'schiffe' :
				$minlvl = 0;
				$maxlvl = 9999;
			break;

			case 'verteidigung' :
				$minlvl = 0;
				$maxlvl = 9999;
			break;

			case 'forschung' :
				$minlvl = 0;
				$maxlvl = 20;
			break;

			default:
				throw new Exception( 'setUp_RandomItemClass() called with unsupported class: '.$class );
			break;
		}

        $randomItemLevels = array();
		$user = Classes::User($uname);
		$user->setActivePlanet($planet);

		if (! $user->getStatus() )
			throw new Exception( "OOOOOOOOOOOOOOOOOPS" );
        $itemList = $user->getItemsList( $class );

		if ( !$itemList )
			throw new Exception( 'setUp_RandomItemClass() couldnt get ItemsList of class: '.$class.' from user '.$user->getName() );

		foreach( $itemList as $item )
		{
			$randomLevel = rand( $minlvl, $maxlvl );
			$randomItemLevels[$item] = $randomLevel;
			$user->changeItemLevel( $item, $randomLevel, $class );
//			echo "added ".$randomLevel." items of ".$item."\n";
		}
		unset( $user );

		return $randomItemLevels;
	}

	/*
	 * sets up a new planet
	 * @args $name - name of the new planet
	 */
	protected function setUp_NewPlanet( $uname, $name = false )
	{
		if ( !$this->setUp_addPlanet( $uname, $name ) )
			throw new Exception( 'setUp_MainPlanet() failed, setUp_addPlanet() returned false' );
	}

	/*
	 * this func will randomize all levels for buildings, research, robots and ships on a given planet
	 * and return its values for asserting
	 *
	 * @args $planet - planet which will be the target
	 * @return array() - array containing the random levels
	 */	
	protected function setUp_RandomizePlanet( $uname, $planet, $research = false )
	{
		$this->random_ItemLevels[$uname][$planet] = $this->setUp_RandomPlanet( $planet, $uname, $research );
	}

	/* 
	 * adds another planet to the user
	 */
	protected function setUp_addPlanet( $uname, $name = false )
	{
        $koords = getFreeKoords();

		if( !User::userExists( $uname ) )
			throw new Exception( 'setUp_MainPlanet() failed, $user is invalid' );

        if( $koords )
        {
//			print "setUp_addPlanet() trying to register a planet for ".$user->getName()." at ".$koords."\n";
			$user = Classes::User( $uname );
            $index = $user->registerPlanet( $koords );

            if ( $index === false )
                throw new Exception( 'setUp_MainPlanet() failed, couldnt setup planet on given coordinates - '.$koords.' for '.$user->getName() );
            else
            {
                $user->setActivePlanet( $index );

				if ( $name )
				{
	                $user->planetName( $name );
					$this->test_PlanetNames[$user->getName()][$index] = $name;
				}

				$this->test_PlanetCoordinates[$user->getName()][$index] = $koords;
				$this->test_PlanetCreated[$user->getName()][$index] = true;
		
				return true;
            }
			unset($user);
        }
        else
            throw new Exception( 'setUp_MainPlanet() failed, no free coordinates for setting up planet' );		
	}

    /**
     * Tears down the fixture, for example, closes a network connection.
     * This method is called after a test is executed.
     *
     * @access protected
     */
    protected function tearDown()
    {
		Classes::resetInstances();

		foreach( $this->test_Users as $index => $uarray )
		{
			$uname = $uarray[0];
			user_control::removeUser( $uname );
		}

		Classes::resetInstances();

		$this->_tearDown_DeleteDir(global_setting("DB_PLAYERS"));
		$this->_tearDown_DeleteDir(global_setting("DB_FLEETS"));

	}

	protected function _tearDown_DeleteDir( $dir )
	{
		
		$exclude = array('.', '..');
		$files = array_diff(scandir($dir), $exclude);
		   
		foreach($files as $value)
		{
			$fname = $dir."/".$value;

			if(!is_dir($fname) && is_file($fname) && is_writable($fname) )
			{
				unlink( $fname );
			}
		}
	}

	/**
	 * test our test setup
	 */
	public function testSetup()
	{
        if ( $this->skipOldTests )
			$this->markTestSkipped();

		foreach( $this->test_Users as $index => $usrarray )
		{
			$this->_testSetup( $usrarray[0] );
		}
	}

	public function _testSetup( $user )
	{
        $this->assertTrue( User::userExists( $this->testUname1 ) );

        for( $i = 0; $i <= $this->_testAndGetMaxPlanets(); $i++ )
        {
            if ( isset( $this->test_PlanetCreated[$user->getName()][$i] ) && $this->test_PlanetCreated[$user->getName()][$i] )
            {
                $this->assertTrue( $user->setActivePlanet( $i ) );
                $this->assertTrue( $user->planetExists( $i ) );
                $this->assertEquals( $this->test_PlanetNames[$user->getName()][$i], $user->planetName() );
                $this->_testPlanetItems( $user, $i );
            }
            else
            {
                $this->assertFalse( $user->setActivePlanet( $i ) );
                $this->assertFalse( $user->planetExists( $i ) );
                //$this->assertFalse( $user->planetName() ); // doesnt work, cause we couldnt change to that planet with setActivePlanet()
            }
        }
	}

	public function _testPlanetItems( $user, $planet = false )
	{
		$this->assertGreaterThanOrEqual( 0, $planet );
		
		$user->setActivePlanet( $planet );
	
		foreach( $this->random_ItemLevels[$user->getName()][$planet] as $key => $value )
		{
			$lvl = $user->getItemLevel( $key, false, false );
			$this->assertEquals( $value, $lvl, '_testPlanetItems() expected level didnt match for given item '.$key.' wanted: '.$value.' got: '.$lvl );
		}
	}

	/**
	 * check new user creation
	 */
	public function	testCreate()
	{
		if ( $this->skipOldTests )
			$this->markTestSkipped();

		// new user
		$newuser = Classes::User( $this->testUname3 );

		// already exists
		$dupuser = Classes::User( $this->testUname1 );

		$this->assertTrue( $newuser->create(), "couldnt create user" );

		$this->test_Users[] = array( $newuser,  $this->testUname3, true );

		$this->assertFalse( $dupuser->create(), "could create user which already exist" );
	}

	public function testUserExists()
	{
		if ( $this->skipOldTests )
			$this->markTestSkipped();

		$this->assertTrue( User::userExists( $this->testUname1 ), "user which was created doesnt exist" );
		$this->assertFalse( User::userExists( $this->testNoUname ), "user which wasnt created does exist" );
		$this->assertFalse( User::userExists( NULL ), "func returned true but no name was given as parameter" );
	}

	public function testPlanetExists()
	{
		if ( $this->skipOldTests )
			$this->markTestSkipped();

		// get our very fist user for testing
		$user = newUser($this->test_Users[0][0]);

		$this->assertTrue( $user->planetExists( 0 ), "planet setup but doesnt exist" );

		for( $i = 0; $i <= $this->_testAndGetMaxPlanets(); $i++ )
		{
			if ( isset( $this->test_PlanetCreated[$user->getName()][$i] ) && $this->test_PlanetCreated[$user->getName()][$i] )
				$this->assertTrue( $user->planetExists( 0 ), "planet setup but doesnt exist" );
			else
				$this->assertFalse( $user->planetExists( $i ), "planet shouldnt exist" );
		}

		// call it with an initialised user but which doesnt exists
		$fuser = Classes::User( "fakeuser1337" );

		for( $i = 0; $i <= $this->_testAndGetMaxPlanets(); $i++ )
		{
			$this->assertFalse( $fuser->planetExists( $i ), "planet shouldnt exists on non-existing user" );
		}
	}

	public function testSetActivePlanet()
	{
		if ( $this->skipOldTests )
			$this->markTestSkipped();

        // get our very fist user for testing
        $user = Classes::User($this->test_Users[0][0]);

		$fuser = Classes::User( "fakeuser1338" );

		$this->assertTrue( $user->setActivePlanet( 0 ), "setting active planet to existing one should work" );

		for( $i = 0; $i <= $this->_testAndGetMaxPlanets(); $i++ )
		{
			$this->assertFalse( $fuser->setActivePlanet( $i ), "planet shouldnt be setable on non-existant user" );
		}
	}

	public function testGetPlanetByPos()
	{
		if ( $this->skipOldTests )
			$this->markTestSkipped();

        // get our very fist user for testing
		$uname = $this->test_Users[0][0];
        $user = Classes::User($uname);

		$fuser = Classes::User( "fakeuser1339" );

		$this->assertFalse( $fuser->getPlanetByPos( false ) );

		for( $i = 0; $i <= TEST_MAX_GALAXIES; $i++ )
		{
			for( $k = 0; $k <= TEST_MAX_SYSTEMSINGALAXY; $k++ )
			{
				for( $m = 0; $m <= TEST_MAX_PLANETSINSYSTEM; $m++ )
				{
					$pos = $i.":".$k.":".$m;
					$bMyPlanet = false;

					foreach( $this->test_PlanetCreated[$uname] as $planet => $isCreated )
					{
						if ( $pos == $this->test_PlanetCoordinates[$uname][$planet] && $isCreated )
						{
							$bMyPlanet = true;
							$this->assertEquals( $planet, $user->getPlanetByPos( $pos ) );
//							echo "found mah planet @ ".$pos."\n"; 
						}
					}

					if ( !$bMyPlanet )
						$this->assertFalse( $user->getPlanetByPos( $pos ) );
				}
			}
		}
	}

	/*
	 * checking if the returned planetlist is the same as our one of the created planets
	 */
	public function testGetPlanetsList()
	{
        if ( $this->skipOldTests )
			$this->markTestSkipped();

		// get our very fist user for testing
        $user = Classes::User($this->test_Users[0][0]);		

		$fuser = Classes::User( "fakeuser1340" );

		$this->assertFalse( $fuser->getPlanetsList() );

		$planets = $user->getPlanetsList();
	
		for( $i = 0; isset( $planets[$i] ) || isset( $this->test_PlanetCreated[$user->getName()][$i] ); $i++ )
		{
			$this->assertTrue( isset( $planets[$i] ) );
			$this->assertTrue( isset( $this->test_PlanetCreated[$user->getName()][$i] ) );
		}
	}

    /*
     * checking if the returned planetlist is the same as our one of the created planets
     */
    public function testRemovePlanet()
    {
        if ( $this->skipOldTests && 0 )
            $this->markTestSkipped();

        // get our very fist user for the fleet start pos, using active planet
		$uname = $this->test_Users[0][0];
        $user = Classes::User( $uname );

		$fuser = Classes::User( "fakeuser1341" );

		$this->assertFalse( $fuser->removePlanet() );

		/*
		 * fleet zurueckrufen welche zu plani unterwegs ist - testen
		 */
		 /*
		$koords = $user->getPosString();
		$i = 0;

		while( $koords == $user->getPosString() && $i < 100 )
		{
			$i++;
			$usr = array_rand( $this->test_PlanetCoordinates );
			$planet = array_rand( $this->test_PlanetCoordinates[$usr] );
			$koords = $this->test_PlanetCoordinates[$usr][$planet];

			$this->assertLessThan( 100, $i );
		}
		*/

		// set active planet to 0 and send fleet to planet 1
		$user->setActivePlanet(0);
		unset($user);
		$this->_testSendFleetTo( $uname, $this->test_PlanetCoordinates[$uname][1] );

        // core func, remove the planet
		$user = Classes::User( $uname );
        $this->assertTrue($user->setActivePlanet(1));
        $this->assertTrue($user->removePlanet());

        // check if the fleet was sent back
        $this->assertTrue( $this->_testIsFleetFlyingBack($this->test_Fleets[$uname][0]) );

        // check if planet still exists
        $galaxy = Classes::Galaxy(1);
        $koords = explode( $mypos );
        $this->assertFalse( $galaxy->getPlanetOwner( $koords[1], $koords[2] ) );
	}

	/*
	 * send a fleet and test if it were created
	 * the actual testing it derivated into a sub method
	 */
	public function _testSendFleetTo( $uname, $pos )
	{
		$fleet = Classes::Fleet();
		$user = Classes::User($uname);
		$mypos =  $user->getPosString();
		unset($user);

//		echo "\nflying from: ".$mypos. " to: ".$pos."\n";
	
		/*
		 * flotte als transport mit 10 kleinen transportern zum ziel $pos versenden
		 */

		$type = 6; // stationieren
		$fleet->create();
		echo "created: ".$fleet."\n"; // no return
		$this->test_Fleets[$uname][] = $fleet->getName();
		echo "setting fleet: ".$fleet->getName()."\n";
while(1)
{
}
exit(1);
		$this->assertTrue( $fleet->addTarget( $pos, $type, false ) );
		$this->assertEquals( $uname, $fleet->addUser( $uname, $mypos, 1 /* default */ ) );
		$this->assertTrue( $fleet->addTransport( $uname, array( 0, 0, 0, 0, 0 ), array() ) );
		$this->assertTrue( $fleet->addFleet( "S1", 100, $uname) );
		$this->assertTrue( $fleet->addHoldTime( 0 ) );
		$this->assertGreaterThan( 0, $fleet->calcNeededTritium( $uname) );
		$fleet->start(); // no return
		$this->assertEquals( $pos, $fleet->getCurrentTarget() );

		$user = Classes::User($uname);
		$this->assertTrue( $user->addFleet( $fleet->getName() ) );
		unset($user);
		unset($fleet);

		$this->_testIsFleetExistingSpecific( $uname, $pos, $mypos, array( "S1", 10 ), $type );
	}

	protected function _testIsFleetFlyingBack( $fleet )
	{
		if(Fleet::fleetExists($fleet))
		{
			$fl = Classes::Fleet($fleet);
if (!$fl->getStatus)
	echo "FUUUUUUUUUUUCK\n";
echo "LOOOL\n";
			return $fl->isFlyingBack();
		}
		else
		{
			echo "OMG :".$fleet."\n";
			exit(1);
			return false;
		}
	}

	/*
	 * test if a given fleet is existant, it is expected to do, otherwise this test will fail
	 */
	public function _testIsFleetExistingSpecific( $from_user, $to_pos, $from_pos, $ships, $type )
	{
		$user = Classes::User($from_user);
		$fleets = $user->getFleetsList();

		$this->assertGreaterThan( 0, count( $fleets ), "no fleets found" );

		$fleet = false;

		foreach( $fleets as $ffleet )
		{
		 	$fleet = $ffleet;
		}
print_r($fleets);	
		if ( $fleet == false )
			throw new Exception( "_testIsFleetExistingSpecific() failed, no fleet found" );
		
		$fleet_obj = Classes::Fleet( $fleet );
		$that = Classes::Fleet( $fleet );
		$blub =	$user->getFleetsWithPlanet();
		
		unset( $user );

		$targets = $that->getTargetsList();

		$this->assertEquals( array( $to_pos ), $targets );
		$this->assertEquals( array( "S1" => 100 ), $fleet_obj->getFleetList( $from_user) );
		$this->assertFalse( $fleet_obj->isFlyingBack() );
	}

	public function _testAndGetMaxPlanets()
	{
		$maxplanets = global_setting( "MAX_PLANETS" );

		$this->assertGreaterThan( 1, $maxplanets );

		return $maxplanets;
	}

}

// Call userTest::main() if this source file is executed directly.
if (PHPUnit_MAIN_METHOD == 'userTest::main') 
{
    userTest::main();
}
?>
